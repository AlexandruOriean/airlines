---
title: "Airlines"
author: "Ben Baumer"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Airlines}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, message=FALSE}
library(dplyr)
library(etl)
library(airlines)
```

## Create the airlines database

First, we create a connection to the database server. We can work with database connections used by either `dplyr` or `DBI`. 

```{r}
# library(RPostgreSQL)
# must have pre-existing database "airlines"
# db <- src_postgres(host = "localhost", user = "postgres", dbname = "airlines")
```

```{r, eval=FALSE}
library(RMySQL)
# must have pre-existing database "airlines"
db <- src_mysql(host = "localhost", user = "r-user", password = "mypass", dbname = "airlines")
airlines <- etl::etl_connect("airlines", db, dir = "~/dumps/airlines")
```

```{r}
airlines <- airlines %>%
  etl_create(year = 2013, month = 9)
```

Once the database is set up, you can update the flights. 

```{r, eval=FALSE}
airlines %>%
  etl_update(year = 2001, month = 3)
  etl_update(year = 2012)
```

Given more time, we might loop through many years. **NOTE: this will take a looong time.**

```{r, eval=FALSE}
years <- 1987:2015
lapply(years, etl_update, obj = etl_airlines)
```

There are several ancillary tables that we can also push to the database server. 

```{r, eval=FALSE}
# copy_to(db, carriers, indexes = list("carrier"), temporary = FALSE)
dbWriteTable(db$con, "carriers", as.data.frame(carriers), field.types = list(carrier = "varchar(7)", name = "varchar(255)"), overwrite=TRUE, row.names = FALSE)
dbWriteTable(db$con, "airports", as.data.frame(airports), field.types = list(faa = "varchar(3)", name = "varchar(255)", lat = "decimal(10,7)", long = "decimal(10,7)", alt = "int", tz = "smallint", dst = "char(1)"), overwrite=TRUE, row.names = FALSE)
dbWriteTable(db$con, "planes", as.data.frame(planes), overwrite=TRUE, row.names = FALSE)
dbWriteTable(db$con, "weather", as.data.frame(weather), overwrite=TRUE, row.names = FALSE)
```


## Accessing the airlines database

Let's see what has been created:

```{r}
dbListTables(db$con)
dbListFields(db$con, "airports")
```

Now we can connect to these tables using `dplyr`:

```{r}
airports <- tbl(db, "airports")
planes <- tbl(db, "planes")
carriers <- tbl(db, "carriers")
flights <- tbl(db, "flights")
```

We can retrieve some basic information about what results are present in the database. 

```{r, eval=FALSE}
flights %>%
   group_by(year, origin) %>%
   summarise(N = n(), numDests = count(distinct(dest)), 
             numCarriers = count(distinct(carrier)), 
             numPlanes = count(distinct(tailnum))) %>%
   arrange(desc(N))
```

## Recover nycflights13

To restrict this to only flights to and from the three New York City airports in 2013, we simply `filter` and `trim`:

```{r, eval=FALSE}
nycFlights13 <- flights %>%
  filter(year == 2013) %>%
  filter(origin %in% c("JFK", "LGA", "EWR"))

tbl_list <- trim(db, flights = nycFlights13)
airports <- collect(tbl_list$airports)
# save(airports, file = "data/airports.rda")
```